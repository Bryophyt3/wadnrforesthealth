@*-----------------------------------------------------------------------
<copyright file="Detail.cshtml" company="Tahoe Regional Planning Agency">
Copyright (c) Tahoe Regional Planning Agency. All rights reserved.
<author>Sitka Technology Group</author>
</copyright>

<license>
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License <http://www.gnu.org/licenses/> for more details.

Source code is available upon request via <support@sitkatech.com>.
</license>
-----------------------------------------------------------------------*@
@using ProjectFirma.Web.Models
@using ProjectFirma.Web.Views
@using ProjectFirma.Web.Views.Shared
@using LtInfo.Common
@using LtInfo.Common.BootstrapWrappers
@using LtInfo.Common.DhtmlWrappers
@using LtInfo.Common.HtmlHelperExtensions
@using LtInfo.Common.ModalDialog
@using ProjectFirma.Web.Common
@using ProjectFirma.Web.Views.Shared.PerformanceMeasureControls

@inherits ProjectFirma.Web.Views.Snapshot.Detail

@section JavascriptAndStylesContent
{
    @{ DhtmlxGridIncludes.RenderPartialView(Html); }

    <script type="text/javascript">
        jQuery(function () {
            jQuery(".performanceMeasureTableSelector")
                .change(function () {
                    jQuery(".performanceMeasureTable").hide();
                    jQuery('#performanceMeasureTable_' + jQuery(this).val()).show();
                });
        })

    </script>
}

<div class="row">
    <div class="col-md-3">
        <div class="panel panelFirma">
            <div class="panel-heading panelTitle">
                <h2>@ModalDialogFormHelper.MakeEditIconLink(ViewDataTyped.SnapshotEditUrl, string.Format("Edit Snapshot for {0}", ViewDataTyped.Snapshot.SnapshotDate.ToLongDateString()), ViewDataTyped.UserHasSnapshotManagePermissions) Snapshot Basics</h2>
            </div>

            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Snapshot Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        @ViewDataTyped.Snapshot.SnapshotDate.ToShortDateString()
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Snapshot Note:</strong>
                    </div>
                    <div class="col-sm-8">
                        @if (!String.IsNullOrWhiteSpace(ViewDataTyped.Snapshot.SnapshotNote))
                        {
                            <span>@ViewDataTyped.Snapshot.SnapshotNote</span>
                        }
                        else
                        {
                            <span>(No Note Specified)</span>
                        }
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Projects Added:</strong>
                    </div>
                    <div class="col-sm-8">
                        @ViewDataTyped.ProjectsAdded.Count
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Projects Updated:</strong>
                    </div>
                    <div class="col-sm-8">
                        @ViewDataTyped.ProjectsUpdated.Count
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Project Count:</strong>
                    </div>
                    <div class="col-sm-8">
                        @ViewDataTyped.Snapshot.ProjectCount
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="panel panelFirma">
            <div class="panel-heading panelTitle">
                <h2>Snapshot of Sector Expenditures on @(ViewDataTyped.Snapshot.SnapshotDate.ToLongDateString())</h2>
            </div>
            <table class="summaryLayout">
                <tr>
                    <th>@Html.LabelWithSugarFor(FieldDefinition.OrganizationType)</th>
                    @foreach (var calendarYear in ViewDataTyped.SectorExpenditureCalendarYears)
                    {
                        <th class="text-right">
                            @calendarYear
                        </th>
                    }
                    <th class="text-right">Total</th>
                </tr>
                @foreach (var organizationType in ViewDataTyped.OrganizationTypes)
                {
                    <tr>
                        <td>@organizationType.OrganizationTypeName</td>
                        @foreach (var calendarYear in ViewDataTyped.SectorExpenditureCalendarYears)
                        {
                            <td class="text-right">@ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Where(expenditure => expenditure.CalendarYear == calendarYear && expenditure.OrganizationType == organizationType).Sum(expenditure => expenditure.ExpenditureAmount).ToStringCurrency()</td>
                        }
                        <th class="text-right">@ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Where(expenditure => expenditure.OrganizationType == organizationType).Sum(expenditure => expenditure.ExpenditureAmount).ToStringCurrency()</th>
                    </tr>
                }
                @if (ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Any())
                {
                    <tr>
                        <th>Total:</th>
                        @foreach (var calendarYear in ViewDataTyped.SectorExpenditureCalendarYears)
                        {
                            <th class="text-right">@ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Where(expenditure => expenditure.CalendarYear == calendarYear).Sum(expenditure => expenditure.ExpenditureAmount).ToStringCurrency()</th>
                        }
                        <th class="text-right">@ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Sum(expenditure => expenditure.ExpenditureAmount).ToStringCurrency()</th>
                    </tr>
                }
            </table>
            @if (!ViewDataTyped.Snapshot.SnapshotSectorExpenditures.Any())
            {
                <p class="alert">No expenditures have been reported for this project.</p>
            }
        </div>
    </div>
</div>

<div class="panel panelFirma">
    <div class="panel-heading panelTitle">
        <h2>Snapshot of @MultiTenantHelpers.GetPerformanceMeasureNamePluralized() on @(ViewDataTyped.Snapshot.SnapshotDate.ToLongDateString())</h2>
    </div>
    <div class="panel-body">
        <select class="performanceMeasureTableSelector" name="performanceMeasureTable">
            <option value="">Select the @MultiTenantHelpers.GetPerformanceMeasureName()</option>
            @foreach (var performanceMeasure in ViewDataTyped.Snapshot.SnapshotPerformanceMeasures.Select(x => x.PerformanceMeasure).Distinct())
            {
                <option value="@performanceMeasure.PerformanceMeasureID">@performanceMeasure.PerformanceMeasureDisplayName</option>
            }
        </select>
        @{ PerformanceMeasureReportedValuesGrouped.RenderPartialView(Html, ViewDataTyped.SnapshotPerformanceMeasureReportedValuesGroupedViewData); }
    </div>
</div>

<div class="panel panelFirma">
    <div class="panel-heading panelTitle">
        <h2>Projects Changed on @(ViewDataTyped.Snapshot.SnapshotDate.ToLongDateString())</h2>
    </div>

    <div class="panel-body">
        @Html.DhtmlxGrid(ViewDataTyped.GridSpec, ViewDataTyped.GridName, ViewDataTyped.GridDataUrl, null, DhtmlxGridResizeType.VerticalFillHorizontalAutoFit)
    </div>
</div>

<div style="margin-top: 20px;">
    <a href="@ViewDataTyped.SnapshotIndexUrl" class="btn btn-sm btn-firma">
        @BootstrapHtmlHelpers.MakeGlyphIcon("glyphicon-chevron-left")
        &nbsp;Index
    </a>
</div>
