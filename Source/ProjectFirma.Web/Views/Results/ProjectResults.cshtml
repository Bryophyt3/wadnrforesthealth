@*-----------------------------------------------------------------------
    <copyright file="ProjectResults.cshtml" company="Tahoe Regional Planning Agency and Sitka Technology Group">
    Copyright (c) Tahoe Regional Planning Agency and Sitka Technology Group. All rights reserved.
    <author>Sitka Technology Group</author>
    </copyright>

    <license>
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License <http://www.gnu.org/licenses/> for more details.

    Source code is available upon request via <support@sitkatech.com>.
    </license>
    -----------------------------------------------------------------------*@
@using ProjectFirma.Web.Views.Shared
@using LtInfo.Common
@inherits ProjectFirma.Web.Views.Results.ProjectResults
@section JavascriptAndStylesContent
{
    <style>
        .counter {
            font-weight: bold;
        }
    </style>
<script src="/Scripts/waypoints.min.js"></script>
<script src="/Scripts/jquery.counterup.min.js"></script>
<script type="text/javascript">
        // <![CDATA[
        function loadOrganizationDashboardSummary()
        {
            var organizationID = jQuery("#organizationDropdown").val();
            var urlTemplate = new Sitka.UrlTemplate(@Html.Raw(ViewDataTyped.OrganizationDashboardSummaryUrl.ToJS()));
            var newUrl = urlTemplate.ParameterReplace(organizationID);

            SitkaAjax.get(newUrl, function (result) {
                jQuery("#projectCount").html(result.ProjectCount);
                jQuery("#partnerCount").html(result.PartnerCount);
                jQuery("#totalInvestment").html(result.TotalInvestment);
                jQuery('.counter').counterUp({
                    delay: 10,
                    time: 1000
                });
            });
        };

        function loadParticipatingOrganizations()
        {
            var organizationID = jQuery("#organizationDropdown").val();
            var urlTemplate = new Sitka.UrlTemplate(@Html.Raw(ViewDataTyped.ParticipatingOrganizationsUrl.ToJS()));
            var newUrl = urlTemplate.ParameterReplace(organizationID);
            SitkaAjax.load(jQuery("#participatingOrganizations"), newUrl);
        };

        function loadOrganizationAccomplishments()
        {
            var organizationID = jQuery("#organizationDropdown").val();
            var taxonomyTierTwoID = jQuery("#taxonomyTierTwoDropdown").val();
            var urlTemplate = new Sitka.UrlTemplate(@Html.Raw(ViewDataTyped.OrganizationAccomplishmentsUrl.ToJS()));
            var newUrl = urlTemplate.ParameterReplace(organizationID, taxonomyTierTwoID);
            SitkaAjax.load(jQuery("#organizationAccomplishments"), newUrl);
        };

        function loadSpendingByOrganizationTypeAndOrganization()
        {
            var organizationID = jQuery("#organizationDropdown").val();
            var beginYear = jQuery("#beginYearDropdown").val();
            var endYear = jQuery("#endYearDropdown").val();
            var urlTemplate = new Sitka.UrlTemplate(@Html.Raw(ViewDataTyped.SpendingByOrganizationTypeAndOrganizationUrl.ToJS()));
            var newUrl = urlTemplate.ParameterReplace(organizationID, beginYear, endYear);
            SitkaAjax.load(jQuery("#spendingByOrganizationTypeAndOrganization"), newUrl);
        };

        function reloadWithNewOrganization() {
            loadOrganizationAccomplishments();
            loadSpendingByOrganizationTypeAndOrganization();
            loadOrganizationDashboardSummary();
            loadParticipatingOrganizations();
        }

        jQuery(document).ready(function() {
            reloadWithNewOrganization();

            jQuery("#accomplishmentsTab").on("shown.bs.tab", function () {
                _.forOwn(window.GoogleCharts.chartWrappers,
                    function (chartWrapper) {
                        if (jQuery('#' + chartWrapper.getContainerId()).is(':visible')) {
                            chartWrapper.getChart().clearChart();
                            chartWrapper.draw();
                        }
                    });
            });
            jQuery("#expendituresTab").on("shown.bs.tab", function() {
                _.forOwn(window.GoogleCharts.chartWrappers,
                    function (chartWrapper) {
                        if (jQuery('#' + chartWrapper.getContainerId()).is(':visible')) {
                            chartWrapper.getChart().clearChart();
                            chartWrapper.draw();
                        }
                    });
            });
            jQuery("#organizationsTab").on("shown.bs.tab", function() {
                _.forOwn(window.GoogleCharts.chartWrappers,
                    function (chartWrapper) {
                        if (jQuery('#' + chartWrapper.getContainerId()).is(':visible')) {
                            chartWrapper.getChart().clearChart();
                            chartWrapper.draw();
                        }
                    });
            });
        });
        // ]]>
</script>
}

<div>
    @{ ViewPageContent.RenderPartialView(Html, ViewDataTyped.ViewPageContentViewData); }
</div>

<div style="margin: 20px 0">
    <label>Show Results For</label>
    <select id="organizationDropdown" onchange="reloadWithNewOrganization()" class="selectpicker" data-live-search="true" data-width="auto">
        <option value="-1">All @ViewDataTyped.ProjectStewardOrganizationTypeName</option>
        @foreach (var organization in ViewDataTyped.Organizations)
        {
            <option value="@organization.OrganizationID">@organization.OrganizationName</option>
        }
    </select>
</div>
<div>
    <h4>Currently Tracking</h4>
    <span id="projectCount" class="counter"></span> Projects
    |
    <span id="partnerCount" class="counter"></span> Partners
    |
    <span>$</span><span id="totalInvestment" class="counter"></span> Total Investment
</div>
<div class="container-fluid">
    <div class="row">
        <ul class="nav nav-tabs" id="projectResultsTabs" style="border-bottom: none;">
            <li class="active">
                <a href="#accomplishmentsPanel" aria-controls="results" role="tab" data-toggle="tab" id="accomplishmentsTab">What types of work do RCDs do?</a>
            </li>
            <li>
                <a href="#expendituresPanel" aria-controls="fundingAndProjects" role="tab" data-toggle="tab" id="expendituresTab">Where does RCD funding come from?</a>
            </li>
            <li>
                <a href="#organizationsPanel" aria-controls="fundingAndProjects" role="tab" data-toggle="tab" id="organizationsTab">Who do RCDs work with?</a>
            </li>
        </ul>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-body">
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="accomplishmentsPanel">
                <div style="margin: 10px">
                    Show Results By
                    <select id="taxonomyTierTwoDropdown" onchange="loadOrganizationAccomplishments()" class="selectpicker" data-live-search="true" data-width="auto">
                        @foreach (var taxonomyTierTwo in ViewDataTyped.TaxonomyTierTwos)
                        {
                            <option value="@taxonomyTierTwo.TaxonomyTierTwoID">@taxonomyTierTwo.TaxonomyTierTwoName</option>
                        }
                    </select>
                </div>                

                <div id="organizationAccomplishments">
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="expendituresPanel">
                <div class="panel panelFirma">
                    <div class="panel-heading panelTitle">
                    </div>
                    <div class="panel-body">
                        <div style="margin: 10px">
                            Show Results From
                            <select id="beginYearDropdown" onchange="loadSpendingByOrganizationTypeAndOrganization()" class="selectpicker" data-width="auto">
                                @foreach (var calendarYear in ViewDataTyped.CalendarYears)
                                {
                                    <option value="@calendarYear" @((ViewDataTyped.DefaultBeginYear == calendarYear).ToSelectedOrEmpty())>@calendarYear</option>
                                }
                            </select>
                            To
                            <select id="endYearDropdown" onchange="loadSpendingByOrganizationTypeAndOrganization()" class="selectpicker" data-width="auto">
                                @foreach (var calendarYear in ViewDataTyped.CalendarYears)
                                {
                                    <option value="@calendarYear" @((ViewDataTyped.DefaultEndYear == calendarYear).ToSelectedOrEmpty())>@calendarYear</option>
                                }
                            </select>
                        </div>
                        <div id="spendingByOrganizationTypeAndOrganization">
                        </div>
                    </div>
                </div>
            </div>            
            <div role="tabpanel" class="tab-pane" id="organizationsPanel">
                <div class="panel panelFirma">
                    <div class="panel-heading panelTitle">
                    </div>
                    <div class="panel-body">
                        <div id="participatingOrganizations">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>