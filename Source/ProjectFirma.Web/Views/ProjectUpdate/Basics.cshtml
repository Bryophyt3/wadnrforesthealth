@*-----------------------------------------------------------------------
<copyright file="Basics.cshtml" company="Sitka Technology Group">
Copyright (c) Sitka Technology Group. All rights reserved.
<author>Sitka Technology Group</author>
<date>Wednesday, February 22, 2017</date>
</copyright>

<license>
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License <http://www.gnu.org/licenses/> for more details.

Source code is available upon request via <support@sitkatech.com>.
</license>
-----------------------------------------------------------------------*@
@using ProjectFirma.Web.Models
@using ProjectFirma.Web.Views.ProjectUpdate
@using LtInfo.Common
@using LtInfo.Common.HtmlHelperExtensions
@using LtInfo.Common.ModalDialog
@using LtInfo.Common.Views
@using Newtonsoft.Json.Linq
@inherits Basics

@section JavascriptAndStylesContent
{
    @if (ViewDataTyped.IsEditable)
    {
        <script type="text/javascript">
            // <![CDATA[
            angular.module("ProjectFirmaApp").controller("BasicsController", function($scope, angularModelAndViewData)
            {
                $scope.AngularViewData = angularModelAndViewData.AngularViewData;
                $scope.AngularModel = angularModelAndViewData.AngularModel;
            });

            angular.module("ProjectFirmaApp").factory("angularModelAndViewData", function()
            {
                return {
                    AngularModel: { ShowValidationWarnings: @Model.ShowValidationWarnings.ToString().ToLower() },
                    AngularViewData: @Html.Raw(JObject.FromObject(ViewDataTyped.ViewDataForAngular))
                    };
            });
            jQuery(document).ready(function() { HookupCheckIfFormIsDirty(undefined, ".submitProject"); });
            // ]]>
        </script>
    }
}

<p>
    Update your project’s basic information here. If this project is complete, be sure to select "Complete" or "Post-Implementation"
    from the Stage dropdown. Changes made here will not take effect until a review approves your updates.
</p>
<hr />
@using (Html.BeginForm())
{
    <div class="form-horizontal">
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(FieldDefinition.TaxonomyTierOne, 600)
            </div>
            <div class="col-md-9">
                @ViewDataTyped.TaxonomyTierOneDisplayName
            </div>
        </div>
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(m => m.ProjectDescription)
            </div>
            <div class="col-md-9">
                @if (ViewDataTyped.IsEditable)
                {
                    @Html.TextAreaWithMaxLengthFor(m => m.ProjectDescription, new TextAreaForExtensions.TextAreaDimensions(null, 6), null)
                    @Html.ValidationMessageFor(m => m.ProjectDescription)
                }
                else
                {
                    <div style="width: 464px">
                        @Html.Raw(ViewDataTyped.ProjectUpdate.ProjectDescription.HtmlEncodeWithBreaks())
                    </div>
                }
            </div>
        </div>
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithFieldDefinitionWiderFor(m => m.ProjectStageID)
            </div>
            <div class="col-md-9">
                @if (ViewDataTyped.IsEditable)
                {
                    @Html.DropDownListFor(m => m.ProjectStageID, ViewDataTyped.ProjectStages)
                    @Html.ValidationMessageFor(m => m.ProjectStageID)
                }
                else
                {
                    @ViewDataTyped.ProjectUpdate.ProjectStage.ProjectStageDisplayName
                }
            </div>
        </div>
        @switch (ViewDataTyped.Project.FundingType.ToEnum)
        {
            case FundingTypeEnum.Capital:
                <div class="row form-group-condensed">
                    <div class="col-md-3 col-header">
                        @Html.LabelWithSugarFor(FieldDefinition.EstimatedTotalCost)
                    </div>
                    <div class="col-md-3">
                        @if (ViewDataTyped.IsEditable)
                        {
                            @Html.EditorFor(m => m.EstimatedTotalCost)
                            @Html.ValidationMessageFor(m => m.EstimatedTotalCost)
                        }
                        else
                        {
                            @ViewDataTyped.ProjectUpdate.EstimatedTotalCost.ToStringCurrency()
                        }
                    </div>
                    @if (CostParameterSet.CanCalculateCapitalCostInYearOfExpenditure(ViewDataTyped.ProjectUpdate))
                    {
                        <div class="col-md-3 col-header">
                            <span>@Html.LabelWithSugarFor(FieldDefinition.ProjectCostInYearOfExpenditure)</span>
                        </div>
                            <div class="col-md-3">
                                <span>@ViewDataTyped.CapitalCostInYearOfExpenditure.ToStringCurrency()</span>
                                <span> (Using @ViewDataTyped.InflationRate.ToStringPercent() annual inflation)</span>
                            </div>
                        

                    }
                </div>
                <div class="row form-group-condensed">
                    <div class="col-md-3 col-header">
                        @Html.LabelWithSugarFor(FieldDefinition.SecuredFunding)
                    </div>
                    <div class="col-md-3">
                        @if (ViewDataTyped.IsEditable)
                        {
                            @Html.EditorFor(m => m.SecuredFunding)
                            @Html.ValidationMessageFor(m => m.SecuredFunding)
                        }
                        else
                        {
                            @ViewDataTyped.ProjectUpdate.SecuredFunding.ToStringCurrency()
                        }
                    </div>
                    <div class="col-md-3">
                        @Html.LabelWithSugarFor(FieldDefinition.UnfundedNeed)
                    </div>
                    <div class="col-md-3">
                        @ViewDataTyped.Project.UnfundedNeed.ToStringCurrency()
                    </div>
                </div>
                        break;
            case FundingTypeEnum.OperationsAndMaintenance:
            <div class="row form-group-condensed">
                <div class="col-md-3 col-header">
                    @Html.LabelWithSugarFor(FieldDefinition.EstimatedAnnualOperatingCost)
                </div>
                <div class="col-md-3">
                    @if (ViewDataTyped.IsEditable)
                    {
                        @Html.EditorFor(m => m.EstimatedAnnualOperatingCost)
                        @Html.ValidationMessageFor(m => m.EstimatedAnnualOperatingCost)
                    }
                    else
                    {
                        @ViewDataTyped.ProjectUpdate.EstimatedAnnualOperatingCost.ToStringCurrency()
                    }
                </div>
                <div class="col-md-3">
                    @Html.LabelWithSugarFor(FieldDefinition.LifecycleOperatingCost)
                </div>
                <div class="col-md-3">
                    @if (CostParameterSet.CanCalculateLifecycleOperatingCost(ViewDataTyped.ProjectUpdate))
                    {
                        @CostParameterSet.LifecycleOperatingCost(ViewDataTyped.ProjectUpdate).ToStringCurrency()
                    }
                </div>
            </div>
                    if (CostParameterSet.CanCalculateTotalRemainingOperatingCostInYearOfExpenditure(ViewDataTyped.ProjectUpdate))
                    {
                        <div class="row form-group-condensed">
                            <div class="col-md-3 col-header">

                                @Html.LabelWithSugarFor(FieldDefinition.CalculatedTotalRemainingOperatingCost)
                            </div>
                            <div class="col-md-9">
                                <span>@ViewDataTyped.TotalOperatingCostInYearOfExpenditure.ToStringCurrency()</span>
                                <span>(For years @ViewDataTyped.StartYearForTotalOperatingCostCalculation-@ViewDataTyped.ProjectUpdate.CompletionYear using @ViewDataTyped.InflationRate.ToStringPercent() annual inflation)</span>
                            </div>
                        </div>
                    }
                    break;
        }
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(m => m.PlanningDesignStartYear)
            </div>
            <div class="col-md-9">
                @if (ViewDataTyped.IsEditable)
                {
                    @Html.DropDownListFor(m => m.PlanningDesignStartYear, ViewDataTyped.PlanningDesignStartYearRange)
                    @Html.ValidationMessageFor(m => m.PlanningDesignStartYear)
                }
                else
                {
                    @ViewDataTyped.ProjectUpdate.PlanningDesignStartYear
                }
            </div>
        </div>

        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(m => m.ImplementationStartYear)
            </div>
            <div class="col-md-3">
                @if (ViewDataTyped.IsEditable)
                {
                    @Html.DropDownListFor(m => m.ImplementationStartYear, ViewDataTyped.ImplementationStartYearRange)
                    @Html.ValidationMessageFor(m => m.ImplementationStartYear)
                }
                else
                {
                    @ViewDataTyped.ProjectUpdate.ImplementationStartYear
                }
            </div>
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(m => m.CompletionYear)
            </div>

            <div class="col-md-3">
                @if (ViewDataTyped.IsEditable)
                {
                    @Html.DropDownListFor(m => m.CompletionYear, ViewDataTyped.CompletionYearRange)
                    @Html.ValidationMessageFor(m => m.CompletionYear)
                }
                else
                {
                    @ViewDataTyped.ProjectUpdate.CompletionYear
                }
            </div>
        </div>
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(FieldDefinition.LeadImplementer)
            </div>
            <div class="col-md-9">
                @if (ViewDataTyped.Project.LeadImplementer != null)
                {
                    <a href="@ViewDataTyped.Project.LeadImplementer.GetSummaryUrl()" target="_blank">@ViewDataTyped.Project.LeadImplementer.DisplayName</a>
                }
            </div>

        </div>
        <div class="row form-group-condensed">
            <div class="col-md-3 col-header">
                @Html.LabelWithSugarFor(FieldDefinition.PrimaryContact)
            </div>
            <div class="col-md-9">
                @if (ViewDataTyped.Project.PrimaryContactPerson != null)
                {
                    <a href="@ViewDataTyped.Project.PrimaryContactPerson.GetDetailUrl()" target="_blank">@ViewDataTyped.Project.PrimaryContactPerson.FullNameFirstLast</a>
                    if (ViewDataTyped.Project.PrimaryContactPerson.Organization != null)
                    {
                        <span>-</span>
                        <a href="@ViewDataTyped.Project.PrimaryContactPerson.Organization.GetSummaryUrl()" target="_blank">@ViewDataTyped.Project.PrimaryContactPerson.Organization.DisplayName</a>
                    }
                }
            </div>
        </div>

    </div>    

    if (ViewDataTyped.IsEditable)
    {
        if (ViewDataTyped.ShowApproveAndReturnButton)
        {
            <hr />
            <div class="row form-group">
                <div class="col-md-3 col-header">@Html.LabelWithSugarFor(x => x.Comments)</div>
                <div class="col-md-9">
                    @Html.TextAreaFor(x => x.Comments, new { @class = "sectionComments" })
                    @Html.Hidden("Section", ViewDataTyped.SelectedProjectUpdateSection)
                </div>            </div>
        }
        <hr />
        SectionComments.RenderPartialView(Html, ViewDataTyped.SectionCommentsViewData);
        <div ng-app="ProjectFirmaApp" ng-controller="BasicsController">
            <table class="summaryLayout" style="width: 100%">
                <tr>
                    <td>
                        @ModalDialogFormHelper.ModalDialogFormLink("Refresh", ViewDataTyped.RefreshUrl, "Refresh this section", 500, "Continue", "Cancel", new List<string> { "btn btn-xs btn-firma" }, null, null)
                        @if (ViewDataTyped.UpdateStatus.IsBasicsUpdated)
                        {
                            @ModalDialogFormHelper.ModalDialogFormLink("diff-link-id", "Show Changes", ViewDataTyped.DiffUrl, "Changes to Project Basics", 800, "hidden-save-button", string.Empty, "diff-close-button", "Close", new List<string> { "btn btn-xs btn-firma" }, null, null, null, new List<string>() { "btn-firma", "btn-xs" })
                        }
                    </td>
                    <td>
                        @if (ViewDataTyped.ViewDataForAngular.ValidationWarnings.Any())
                        {
                            <div data-ng-show="AngularModel.ShowValidationWarnings" data-ng-class="AngularModel.ShowValidationWarnings ? 'alert alert-danger' : 'hidden'">
                                <ul>
                                    <li data-ng-repeat="warning in AngularViewData.ValidationWarnings">
                                        <span data-ng-bind="warning"></span>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div ng-show="AngularModel.ShowValidationWarnings" data-ng-class="AngularModel.ShowValidationWarnings ? 'alert alert-success' : 'hidden'">
                                <span>This page is all set!  Nice work.  You should take the rest of the day off.</span>
                            </div>
                        }
                    </td>
                    <td style="text-align: right; white-space: nowrap">
                        @Html.CheckBoxFor(x => x.ShowValidationWarnings, new { data_ng_model = "AngularModel.ShowValidationWarnings", @class = "ignoreSerialization" })
                        @Html.LabelWithSugarFor(x => x.ShowValidationWarnings)
                        <button class="btn btn-xs btn-firma" type="submit" style="margin-left: 10px">Save</button>
                    </td>
                </tr>
            </table>
        </div>
    }
}
