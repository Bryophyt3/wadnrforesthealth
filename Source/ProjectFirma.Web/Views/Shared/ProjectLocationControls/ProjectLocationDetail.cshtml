@*-----------------------------------------------------------------------
    <copyright file="ProjectLocationDetail.cshtml" company="Tahoe Regional Planning Agency and Sitka Technology Group">
    Copyright (c) Tahoe Regional Planning Agency and Sitka Technology Group. All rights reserved.
    <author>Sitka Technology Group</author>
    </copyright>

    <license>
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License <http://www.gnu.org/licenses/> for more details.

    Source code is available upon request via <support@sitkatech.com>.
    </license>
    -----------------------------------------------------------------------*@
@using LtInfo.Common
@using LtInfo.Common.ModalDialog
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@using ProjectFirma.Web.Models
@inherits ProjectFirma.Web.Views.Shared.ProjectLocationControls.ProjectLocationDetail

<style>
    .mapEditor textarea {
        resize: none;
        height: 60px;
    }
</style>

<p>
    Create a drawing of your @FieldDefinition.Project.GetFieldDefinitionLabel()’s implementation (but not the full area affected by your @FieldDefinition.Project.GetFieldDefinitionLabel()).
    The detailed @FieldDefinition.ProjectLocation.GetFieldDefinitionLabel() information will appear on the @FieldDefinition.Project.GetFieldDefinitionLabel() Fact Sheet and @FieldDefinition.Project.GetFieldDefinitionLabel() summary page.
    <ul>
        <li>To zoom to your @FieldDefinition.Project.GetFieldDefinitionLabel() area hold down the Shift key and drag a rectangle.</li>
        <li>Use the edit tools on the left of the map to add point, line, and polygon features representing details of your @FieldDefinition.Project.GetFieldDefinitionLabel(), such as the @FieldDefinition.Project.GetFieldDefinitionLabel() boundary, a specific stream segment, or an area of interest.</li>
        <li>After adding a feature, click it to provide a brief description of the feature.</li>
    </ul>
</p>
<hr />
<p>
    <span style="margin-right:10px">Instead of drawing your @FieldDefinition.Project.GetFieldDefinitionLabel() details by hand, you may alternately upload a GIS file.</span>
    @ModalDialogFormHelper.ModalDialogFormLink(null,
        "Upload a GIS File",
        ViewDataTyped.UploadGisFileUrl,
        "Upload ArcGIS File Geodatabase",
        1000,
        ModalDialogFormHelper.SaveButtonID,
        "Approve Upload",
        "Cancel",
        new List<string>(){"btn", "btn-sm", "btn-firma"},
        null,
        null,
        ViewDataTyped.MapFormID,
        null)
</p>


<div id="@ViewDataTyped.MapInitJson.MapDivID" style="height: 500px">
</div>
@if (ViewDataTyped.HasProjectLocationPoint)
{
    <div>
        <img style="margin-top: 10px; margin-right: 5px;" src="@ViewDataTyped.SimplePointMarkerImg"> Simple @FieldDefinition.Project.GetFieldDefinitionLabel() location (for reference)
    </div>
}

<div layout:fragment="WizardContent" data-ng-app="ProjectLocationDetailApp" data-ng-controller="ProjectLocationDetailController">


    <form method="POST" id="projectLocationsForm" name="projectLocationsForm" th:action="@ViewDataTyped.PostUrl" th:object="@ViewModel" data-ng-submit="reprojectGeometries()">
        <div>
            <table class="table table-bordered table-projectLocations">
                <thead>
                    <tr>
                        <th data-ng-if="!AngularViewDataTyped.isInCompletedReview"></th>
                        <th style="width: 150px">Feature Name</th>
                        <th>Feature</th>
                        <th>Location Type</th>
                        <th style="width: 250px">Notes</th>
                    </tr>
                </thead>
                <tr data-ng-repeat="projectLocation in AngularModel.projectLocationJsons" class="clickable-row"
                    data-ng-class="{'selectedRow': isSelectedProjectLocation(projectLocation)}"
                    data-ng-click="toggleProjectLocationDetails(projectLocation.projectLocationID)">
                    <td data-ng-if="!AngularViewDataTyped.isInCompletedReview">
                        @*Delete button*@
                        <a href="javascript:void(0)" data-ng-click="deleteProjectLocationRowAndRefreshMap(projectLocation)">
                            <span class="glyphicon glyphicon-trash"></span>
                        </a>
                    </td>
                    <td style="width: 150px">
                        <input type="text" name="projectLocationJsons[{{$index}}].projectLocationName"
                               data-ng-model="projectLocation.projectLocationName" style="width: 100%" required maxlength="200" />
                        <div class="alert alert-danger field-validation-error" role="alert" data-ng-if="hasProjectLocationError($index, 'projectLocationName')">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <span data-ng-bind="getProjectLocationErrorMessage($index, 'projectLocationName')"></span>
                        </div>
                        <input type="hidden" name="projectLocationJsons[{{$index}}].projectLocationID" value="{{projectLocation.projectLocationID}}" />
                    </td>
                    <td>
                        @*Feature Type: ie. Line, Point, Poly*@
                        <span data-ng-bind="projectLocation.projectLocationGeometryType"></span>
                        <input type="hidden" name="projectLocationJsons[{{$index}}].projectLocationGeometry"
                               value="{{projectLocation.projectLocationGeometry}}"/>
                    </td>
                    <td>
                        @*ProjectLocationType. pulled from enum/table *@
                        <select name="projectLocationJsons[{{$index}}].projectLocationTypeID"
                                data-ng-model="projectLocation.projectLocationTypeID" required>
                            <option value="">-- Select type --</option>
                            <option data-ng-repeat="projectLocationType in getSelectableProjectLocationTypes(projectLocation)"
                                    value="{{projectLocationType.projectLocationTypeID}}">
                                {{projectLocationType.projectLocationTypeName}}
                            </option>
                        </select>
                        <div class="alert alert-danger field-validation-error" role="alert" data-ng-if="hasProjectLocationError($index, 'projectLocationTypeID')">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <span data-ng-bind="getProjectLocationErrorMessage($index, 'projectLocationTypeID')"></span>
                        </div>
                    </td>              
                    <td style="width: 250px">
                        @* notes *@
                        <input type="text" name="projectLocationJsons[{{$index}}].notes" data-ng-model="projectLocation.notes" style="width: 100%" maxlength="500"/>
                        <div class="alert alert-danger field-validation-error" role="alert" data-ng-if="hasProjectLocationError($index, 'notes')">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <span data-ng-bind="getProjectLocationErrorMessage($index, 'notes')"></span>
                        </div>
                    </td>
                </tr>
            </table>
        </div>



        <div class="alert alert-danger" role="alert" data-ng-repeat="projectLocationJson in getProjectLocationsWithProjectLocationTypesNotAlignedWithGeometryType()">
            For ProjectLocation "{{projectLocationJson.projectLocationName}}", you indicated you have a "{{getProjectLocationTypeName(projectLocationJson.projectLocationTypeID)}}" ProjectLocation Type, yet represented it using a {{projectLocationJson.projectLocationGeometryType}}. While this is allowed, please make sure this is what you want to do.
        </div>

        <div class="projectComment">
            <hr>
            <h4>Review Comments</h4>
            <textarea class="form-control" th:field="*{comments}" maxlength="1000"></textarea>
            <div class="alert alert-danger field-validation-error" role="alert"
                 th:if="$fields.hasErrors('comments')">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span th:errors="*{comments}"></span>
            </div>
        </div>

        <div class="wizardButtonGroup">
            <hr>
            <button type="submit" class="btn btn-primary" value="false" name="autoAdvance">
                Save
            </button>
            <button type="submit" class="btn btn-primary" value="true" name="autoAdvance">
                Save &amp; Continue
            </button>
        </div>
    </form>

    <div id="uploadGisModal" class="modal fade kevin-modal" tabindex="-1" role="dialog">
        <form id="uploadGisForm" th:action="@ViewDataTyped.UploadGisUrl" enctype="multipart/form-data" class="">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Upload GIS File</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            Select the type of GIS File to upload from the list of supported formats.
                        </p>
                        <div class="form-group">
                            <label for="uploadGisInputType" style="width: 100%;">GIS File Type</label>
                            <select name="uploadGisType" id="uploadGisInputType" class="form-control" style="width: auto;">
                                <option value="">-- Select Type --</option>
                                <option th:each="type:@ViewDataTyped.UploadGisTypes" th:value="$type.ordinal()" th:text="$type.displayName"></option>
                            </select>
                        </div>
                        <div class="form-group uploadGidInputFileGroup">
                            <label for="uploadGisInputFile">GIS File</label>
                            <input id="uploadGisInputFile" name="gisFile" type="file" class="file" style="margin-bottom: 10px;">
                            <div class="uploadGisInputFileHelpBlock" th:each="type:@ViewDataTyped.UploadGisTypes" th:attr="data-uploadgistypeid=$type.ordinal()">
                                <p class="help-text">
                                    Supported extensions:
                                    <em th:text="${#strings.arrayJoin(type.supportedExtensions,', ')}"></em>
                                </p>
                                <p class="help-text" th:text="$type.instructionText"></p>
                            </div>
                        </div>
                        <div class="progress" style="display: none;">
                            <div class="progress-bar progress-bar-striped active" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary uploadGisSubmit" data-ng-click="uploadGisFile()">Upload</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div th:replace="proposedProject/ProjectAndProjectLocationType :: projectAndProjectLocationType"></div>
</div>
<div layout:fragment="javascriptWizard" th:remove="tag">
    @*<div th:replace="dhtmlx/IncludeJavascript :: dhtmlx-javascript"></div>*@
    <script type="text/javascript" src="~/Content/angular/angular.min.js"></script>
    <script type="text/javascript" src="~/Content/angular/angular-sanitize.min.js"></script>
    @*<script type="text/javascript" src="/ng-text-truncate-master/ng-text-truncate.js"></script>*@
    <script type="text/javascript" src="~/Views/Shared/ProjectLocationControls/ProjectLocationDetailController.js"></script>
    <div th:replace="leaflet/IncludeJavascript :: leaflet-javascript"></div>

    <script type="text/javascript" th:inline="javascript">
        angular.module("ProjectLocationDetailApp").factory("angularModelAndViewData", function () {
            return {
                AngularModel: [[@ViewModel]], AngularViewData: [[@ViewDataTyped.AngularViewData]]
            };
        });
        jQuery(function () {
            // Override Dhtmlxgrid reset button to work in modal
            Sitka.projectAndProjectLocationTypeGrid.clearAllCookies = function () {
                this.grid.clearConfigCookie();
                this.clearSavedFilterValues();
                Sitka.Methods.eraseCookie(this.getGridCookieName() + "filterVisible");

                jQuery(this.grid.entBox).find(".filter :input").val("").trigger("keydown").trigger("change");
            };
            var uploadGisInputTypeInput = jQuery("#uploadGisInputType");
            uploadGisInputTypeInput.on("change", function (event) {
                jQuery(".uploadGisInputFileHelpBlock").hide();
                var selectedInputType = jQuery(event.target).val();
                if (!Sitka.Methods.isUndefinedNullOrEmpty(selectedInputType)) {
                    jQuery(".uploadGidInputFileGroup").show();
                    jQuery(".uploadGisInputFileHelpBlock[data-uploadgistypeid=" + selectedInputType + "]").show()
                    jQuery(".uploadGisSubmit").prop("disabled", false);
                } else {
                    jQuery(".uploadGidInputFileGroup").hide();
                    jQuery(".uploadGisSubmit").prop("disabled", true);
                }
            });
            uploadGisInputTypeInput.trigger("change");

            HookupCheckIfFormIsDirtyNoDisable("#projectLocationsForm");
        });
    </script>
</div>






<script type="text/javascript">
    getDrawOptions = function(editableFeatureGroup)
    {
        var myIcon = L.MakiMarkers.icon({
            icon: "marker",
            color: "#f357a1",
            size: "m"
        });

        var options = {
            position: 'topleft',
            draw: {
                polyline: {
                    shapeOptions: {
                        color: '#f357a1',
                        weight: 10
                    }
                },
                polygon: {
                    allowIntersection: false, // Restricts shapes to simple polygons
                    drawError: {
                        color: '#e1e100', // Color the shape will turn when intersects
                        message: 'Self-intersecting polygons are not allowed.' // Message that will show when intersect
                    },
                    shapeOptions: {
                        color: '#f357a1'
                    }
                },
                circle: false, // Turns off this drawing tool
                rectangle: {
                    shapeOptions: {
                        color: "#f357a1"
                    }
                },
                marker: {
                    icon: myIcon
                }
            },
            edit: {
                featureGroup: editableFeatureGroup, //REQUIRED!!
                edit: {
                    maintainColor: true,
                    opacity: 0.3
                },
                remove: true
            }
        };
        return options;
    };

    var projectFirmaMap;
    jQuery(document).ready(function()
    {
        var mapInitJson = @Html.Raw(JObject.FromObject(ViewDataTyped.MapInitJson).ToString(Formatting.None));
        var editableFeatureJsonObject = @Html.Raw(JObject.FromObject(ViewDataTyped.EditableLayerGeoJson).ToString(Formatting.None));
        projectFirmaMap = new ProjectFirmaMaps.Map(mapInitJson);

        projectFirmaMap.editableFeatureGroup = new L.FeatureGroup();

        var bindAnnotationPopup = function(layer, feature)
        {
            var leafletId = layer._leaflet_id;
            var popupOptions = {
                minWidth: 200
            };
            layer.bindPopup("", popupOptions);
            layer.on('click', function(f)
            {
                if(layer.editing.enabled())
                {
                    f.target.closePopup();
                    return;
                }
                var popup = f.target._popup;
                var annotation = Sitka.Methods.isUndefinedNullOrEmpty(feature) ? "" : Sitka.Methods.isUndefinedNullOrEmpty(feature.properties.Info) ? "" : feature.properties.Info;
                var annotationMaxLength = @ViewDataTyped.AnnotationMaxLength;
                var charsRemaining = annotationMaxLength - annotation.length;
                var textareaId = projectFirmaMap.getTextAreaId(leafletId);
                var charRemainingForTextareaId = "CharactersRemaining_" + textareaId;
                var popupContent = "<b>Notes:</b> <br />" +
                    "<textarea id=\"" + textareaId + "\" " +
                    "onkeyup=\"Sitka.Methods.keepTextAreaWithinMaxLength(this, " + annotationMaxLength + ", 20, '" + charRemainingForTextareaId + "', 'Characters Remaining: ');\" " +
                    "onkeydown=\"Sitka.Methods.keepTextAreaWithinMaxLength(this, " + annotationMaxLength + ", 20, '" + charRemainingForTextareaId +  "', 'Characters Remaining: ');\">" +
                    annotation + "</textarea>" +
                    "<div id=\"" + charRemainingForTextareaId + "\" style=\"text-align:right;color:#666666;\">Characters Remaining: " + charsRemaining + "</div><br />" +
                    "<button id=\"buttonFor" + leafletId + "\" class=\"button btn-xs btn-info\" onclick=\"savePopupAnnotationEditor(" + leafletId + ")\">Save</button>";
                popup.setContent(popupContent);
                popup.update();

                jQuery("#textboxFor" + leafletId).focus();
            });
        };

        var layerGroup = L.geoJson(editableFeatureJsonObject.GeoJsonFeatureCollection, {
            onEachFeature: function(feature, layer)
            {
                if (layer.getLayers)
                {
                    layer.getLayers().forEach(function(l) { projectFirmaMap.editableFeatureGroup.addLayer(l); });
                }
                else
                {
                    projectFirmaMap.editableFeatureGroup.addLayer(layer);
                }
                bindAnnotationPopup(layer, feature);
            }
        });

        var drawOptions = getDrawOptions(projectFirmaMap.editableFeatureGroup);
        var drawControl = new L.Control.Draw(drawOptions);
        projectFirmaMap.map.addControl(drawControl);
        projectFirmaMap.map.addLayer(projectFirmaMap.editableFeatureGroup);

        projectFirmaMap.map.on('draw:created', function(e)
        {
            var layer = e.layer;
            projectFirmaMap.editableFeatureGroup.addLayer(layer);
            var leafletId = layer._leaflet_id;
            projectFirmaMap.editableFeatureGroup._layers[leafletId].feature = new Object();
            projectFirmaMap.editableFeatureGroup._layers[leafletId].feature.properties = new Object();
            projectFirmaMap.editableFeatureGroup._layers[leafletId].feature.type = "Feature";
            var feature = projectFirmaMap.editableFeatureGroup._layers[leafletId].feature;
            bindAnnotationPopup(layer, feature);
            updateFeatureCollectionJson();
        });
        projectFirmaMap.map.on('draw:edited', function(e)
        {
            updateFeatureCollectionJson();
        });

        projectFirmaMap.map.on('draw:deleted', function(e)
        {
            updateFeatureCollectionJson();
        });

        updateFeatureCollectionJson();

        var saveButton = jQuery("#" + "@ModalDialogFormHelper.SaveButtonID");
        if(!Sitka.Methods.isUndefinedNullOrEmpty(saveButton))
        {
            saveButton.text("Save");
        }

        var modalTitle = jQuery(".ui-dialog-title");
        if(!Sitka.Methods.isUndefinedNullOrEmpty(modalTitle))
        {
            modalTitle.html("@(string.Format("Edit {0} - Detail", FieldDefinition.ProjectLocation.GetFieldDefinitionLabel()))");
        }
    });

    ProjectFirmaMaps.Map.prototype.getTextAreaId = function(featureId) { return "textareaFor" + featureId; };


    function savePopupAnnotationEditor(featureId)
    {
        var textBoxForPopup = jQuery("#" + projectFirmaMap.getTextAreaId(featureId));
        projectFirmaMap.editableFeatureGroup._layers[featureId].feature.properties.Info = textBoxForPopup.val();
        projectFirmaMap.map.closePopup();
        updateFeatureCollectionJson();
    }

    function updateFeatureCollectionJson()
    {
        var geoJson = projectFirmaMap.editableFeatureGroup.toGeoJSON();
        var mapForm = jQuery("#" + "@ViewDataTyped.MapFormID");
        mapForm.html("");
        var hiddens = [];
        for(var i = 0; i < geoJson.features.length; ++i)
        {
            var currentWktName = "name=\"@Html.NameFor(x => x.WktAndAnnotations[0].Wkt)\"".replace("0", i);
            var currentWktAnnotation = "name=\"@Html.NameFor(x => x.WktAndAnnotations[0].Annotation)\"".replace("0", i);
            hiddens.push("<input type=\"hidden\" " + currentWktName + " value=\"" + Terraformer.WKT.convert(geoJson.features[i].geometry) + "\" />");
            hiddens.push("<input type=\"hidden\" " + currentWktAnnotation + " value=\"" + Sitka.Methods.htmlEncode(geoJson.features[i].properties.Info) + "\" />");
        }
        mapForm.html(hiddens.join("\r\n"));
    }
</script>

<form method="POST" id="@ViewDataTyped.MapFormID" action="@ViewDataTyped.SaveFeatureCollectionUrl"></form>
