@using ProjectFirma.Web.Models
@using LtInfo.Common.HtmlHelperExtensions
@using Newtonsoft.Json.Linq
@inherits ProjectFirma.Web.Areas.EIP.Views.TransportationProjectBudget.EditTransportationProjectBudgets
<script type="text/javascript">
    // <![CDATA[
    angular.module("ProjectFirmaApp").factory("angularModelAndViewData", function()
    {
        return {
            AngularModel: @Html.Raw(JObject.FromObject(Model)),
            AngularViewData: @Html.Raw(JObject.FromObject(ViewDataTyped))
        };
    });
    angular.bootstrap(jQuery("#EditTransportationProjectBudgetsApp"), ["ProjectFirmaApp"]);
    // ]]>
</script>

<div class="validationError">
    @Html.ValidationSummary()
</div>

<div ng-app="ProjectFirmaApp" id="EditTransportationProjectBudgetsApp" ng-controller="TransportationProjectBudgetController" style="max-height: 600px; overflow-y: auto">
    <div class="row">
        <div class="col-md-3">
            Funding Source to Add:
        </div>
        <div class="col-md-9">
            <select ng-model="FundingSourceToAdd" ng-options="fundingSource.DisplayName group by fundingSource.OrganizationName for fundingSource in filteredFundingSources()" style="width: 500px"></select>
            <button class="btn btn-xs btn-trpa" type="button" ng-click="addRow()">Add</button>
            <br/>
            <label style="font-size: 12px"><input type="checkbox" ng-model="ShowOnlyProjectFunders"/>Show only my project's Funders</label>
        </div>
    </div>
    <div>
        Group By:
        <label>
            <input type="radio" name="budgetGroupedBy" checked="checked" ng-click="setGroupByTransportationProjectCostType(false)"/>
            Funding Source
        </label>
        <label>
            <input type="radio" name="budgetGroupedBy" ng-click="setGroupByTransportationProjectCostType(true)"/>
            Cost Type
        </label>
    </div>
    <table class="dialogFormLayout" style="overflow: scroll" ng-show="AngularModel.TransportationProjectBudgets.length > 0">
        <tr>
            <th colspan="3" style="white-space: nowrap">@Html.LabelWithFieldDefinitionFor(FieldDefinition.FundingSource)</th>
            <th ng-repeat="calendarYear in getCalendarYearRange()" style="text-align: right; vertical-align: top">
                <span class="glyphicon glyphicon-plus-sign blue" ng-click="addCalendarYear(calendarYear - 1)" ng-show="$first" title="Add Previous Year '{{calendarYear - 1}}'" alt="Add Previous Year '{{calendarYear - 1}}'" style="cursor: pointer"></span>
                <span ng-bind="calendarYear"></span>
                <span class="glyphicon glyphicon-plus-sign blue" ng-click="addCalendarYear(calendarYear + 1)" ng-show="$last" title="Add Next Year '{{calendarYear + 1}}'" alt="Add Next Year '{{calendarYear + 1}}'" style="cursor: pointer"></span>
            </th>
            <th style="text-align: right">Total</th>
        </tr>
        <tbody ng-repeat="fundingSourceID in getAllUsedFundingSourceIds() | orderBy:[getFundingSourceNameById]" ng-show="!IsGroupedByTransportationProjectCostType">
        <tr>
            <td style="white-space: nowrap">
                <span class="glyphicon glyphicon-collapse-down blue" ng-click="showHideTransportationProjectCostTypes(fundingSourceID)" ng-show="existsInFundingSourcesNotShowingTransportationProjectCostTypes(fundingSourceID)" title="Show Cost Types" alt="Show Cost Types" style="cursor: pointer"></span>
                <span class="glyphicon glyphicon-collapse-up blue" ng-click="showHideTransportationProjectCostTypes(fundingSourceID)" ng-show="!existsInFundingSourcesNotShowingTransportationProjectCostTypes(fundingSourceID)" title="Hide Cost Types" alt="Hide Cost Types" style="cursor: pointer"></span>
                <span class="glyphicon glyphicon-trash blue" title="Remove row" alt="Remove row" ng-click="deleteFundingSourceRow(fundingSourceID)" style="cursor: pointer"></span>
            </td>
            <td colspan="2">
                <span ng-bind="getFundingSourceNameById(fundingSourceID)"></span>
            </td>
            <td style="text-align: right; width: 75px" ng-repeat="calendarYear in getCalendarYearRange()">
                <span ng-bind="getBudgetTotalForFundingSourceAndCalendarYear(fundingSourceID, calendarYear) | nfcurrency"></span>
            </td>
            <th style="text-align: right" ng-bind="getBudgetTotalForFundingSource(fundingSourceID) | nfcurrency">
            </th>
        </tr>
        <tr ng-repeat="transportationProjectBudget in getTransportationProjectBudgetRowsForFundingSource(fundingSourceID)" ng-show="!existsInFundingSourcesNotShowingTransportationProjectCostTypes(fundingSourceID)">
            <td></td>
            <td style="width: 15px">&nbsp;</td>
            <td ng-bind="getTransportationProjectCostTypeName(transportationProjectBudget)"/>
            <td style="text-align: right; width: 75px" ng-repeat="calendarYearBudget in transportationProjectBudget.CalendarYearBudgets | orderBy:'CalendarYear'">
                <input type="text" ng-model="calendarYearBudget.MonetaryAmount" class="sitkaCurrency" ng-currency />
            </td>
            <th style="text-align: right" ng-bind="getBudgetTotalForRow(transportationProjectBudget) | nfcurrency">
            </th>
        </tr>
        <tr>
            <td colspan="{{getCalendarYearRange().length + 4}}">
                <hr style="border-color: #9e9e9e"/>
            </td>
        </tr>
        </tbody>

        <tbody ng-repeat="transportationProjectCostType in AngularViewData.AllTransportationProjectCostTypes | orderBy:'SortOrder'" ng-show="IsGroupedByTransportationProjectCostType">
        <tr>
            <td>
                <span class="glyphicon glyphicon-collapse-down blue" ng-click="showHideFundingSources(transportationProjectCostType)" ng-show="existsInHiddenTransportationProjectCostTypes(transportationProjectCostType)" title="Show Funding Sources" alt="Show Funding Sources" style="cursor: pointer"></span>
                <span class="glyphicon glyphicon-collapse-up blue" ng-click="showHideFundingSources(transportationProjectCostType)" ng-show="!existsInHiddenTransportationProjectCostTypes(transportationProjectCostType)" title="Hide Funding Sources" alt="Hide Funding Sources" style="cursor: pointer"></span>
            </td>
            <td colspan="2">
                <span ng-bind="transportationProjectCostType.TransportationProjectCostTypeDisplayName"></span>
            </td>
            <td style="text-align: right; width: 75px" ng-repeat="calendarYear in getCalendarYearRange()">
                <span ng-bind="getBudgetTotalForTransportationProjectCostTypeAndCalendarYear(transportationProjectCostType.TransportationProjectCostTypeID, calendarYear) | nfcurrency"></span>
            </td>
            <th style="text-align: right" ng-bind="getBudgetTotalForTransportationProjectCostType(transportationProjectCostType.TransportationProjectCostTypeID) | nfcurrency">
            </th>
        </tr>
        <tr ng-repeat="transportationProjectBudget in getTransportationProjectBudgetRowsForTransportationProjectCostType(transportationProjectCostType) | orderBy:[getFundingSourceName]" ng-show="!existsInHiddenTransportationProjectCostTypes(transportationProjectCostType)">
            <td></td>
            <td>
                <span class="glyphicon glyphicon-trash blue" title="Remove row" alt="Remove row" ng-click="deleteFundingSourceRow(transportationProjectBudget.FundingSourceID)" style="cursor: pointer"></span>
            </td>
            <td ng-bind="getFundingSourceName(transportationProjectBudget)"/>
            <td style="text-align: right; width: 75px" ng-repeat="calendarYearBudget in transportationProjectBudget.CalendarYearBudgets | orderBy:'CalendarYear'">
                <input type="text" ng-model="calendarYearBudget.MonetaryAmount" class="sitkaCurrency" ng-currency />
            </td>
            <th style="text-align: right" ng-bind="getBudgetTotalForRow(transportationProjectBudget) | nfcurrency">
            </th>
        </tr>
        <tr>
            <td colspan="{{getCalendarYearRange().length + 4}}">
                <hr style="border-color: #9e9e9e"/>
            </td>
        </tr>
        </tbody>
        <tr>
            <th colspan="3">Total:</th>
            <th ng-repeat="calendarYear in getCalendarYearRange()" style="text-align: right" ng-bind="getBudgetTotalForCalendarYear(calendarYear) | nfcurrency">
            </th>
            <th style="text-align: right" ng-bind="getBudgetTotalForCalendarYear() | nfcurrency">
            </th>
        </tr>
    </table>

    @using (Html.BeginForm())
    {
        <div ng-repeat="transportationProjectBudget in AngularModel.TransportationProjectBudgets | orderBy:[getFundingSourceName]">
            <input type="hidden" name="@Html.NameFor(x => x.TransportationProjectBudgets[0].ProjectID).ToString().Replace("0", "{{$index}}")" value="{{transportationProjectBudget.ProjectID}}">
            <input type="hidden" name="@Html.NameFor(x => x.TransportationProjectBudgets[0].FundingSourceID).ToString().Replace("0", "{{$index}}")" value="{{transportationProjectBudget.FundingSourceID}}">
            <input type="hidden" name="@Html.NameFor(x => x.TransportationProjectBudgets[0].TransportationProjectCostTypeID).ToString().Replace("0", "{{$index}}")" value="{{transportationProjectBudget.TransportationProjectCostTypeID}}">
            <div ng-repeat="calendarYearBudget in transportationProjectBudget.CalendarYearBudgets | orderBy:'CalendarYear'">
                <input type="hidden" name="@Html.NameFor(x => x.TransportationProjectBudgets[0].CalendarYearBudgets[1].CalendarYear).ToString().Replace("0", "{{$parent.$index}}").Replace("1", "{{$index}}")" value="{{calendarYearBudget.CalendarYear}}">
                <input type="hidden" name="@Html.NameFor(x => x.TransportationProjectBudgets[0].CalendarYearBudgets[1].MonetaryAmount).ToString().Replace("0", "{{$parent.$index}}").Replace("1", "{{$index}}")" value="{{calendarYearBudget.MonetaryAmount}}">
            </div>
        </div>
    }
</div>